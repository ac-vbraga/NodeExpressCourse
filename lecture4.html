<!DOCTYPE HTML>
<!--
	Read Only by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Node.js - Lecture 4</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
		<script src="js/jquery.min.js"></script>
		<script src="js/jquery.scrollzer.min.js"></script>
		<script src="js/jquery.scrolly.min.js"></script>
		<script src="js/skel.min.js"></script>
		<script src="js/skel-layers.min.js"></script>
		<script src="js/init.js"></script>
		
		<noscript>
			<link rel="stylesheet" href="css/skel.css" />
			<link rel="stylesheet" href="css/style.css" />
			<link rel="stylesheet" href="css/style-xlarge.css" />
		</noscript>

		<style>
			.ac-caption {
				margin: 5px 0px 10px 0px;
				font-size: 13px;
  				text-align: center;
			}

			#header > nav ul li a {
				padding: 0px;
				font-size: 0.8em;
			}

			#one:before {
				background-image: none;
				height: 0em;
			}

			header.major h2 {
				line-height: 1em;
			}
		</style>

		<!--[if lte IE 8]><link rel="stylesheet" href="css/ie/v8.css" /><![endif]-->
	</head>
	<body>
		<div id="wrapper">

			<!-- Header -->
				<section id="header" class="skel-layers-fixed">
					<header>
						
						<h1 id="logo"><a href="#">Node.js - Lecture 4</a></h1>
						
					</header>
					<nav id="nav">
						<ul>
							<li><a href="#one" class="active">Grunt</a></li>
							<li><a href="#two">Test</a></li>
							<li><a href="#three">Cookie Authentication</a></li>
						</ul>
						<img src="http://www.avenuecode.com/wp-content/themes/ac-site/images/white-logo.png" alt="">
					</nav>
					<footer>
					</footer>
				</section>

			<!-- Main -->
				<div id="main">

					<!-- One -->
          <section id="one">
            <div class="container">
              <header class="major">
                <h2>Grunt</h2>
              </header>

              <header>
                <h4>What is Grunt?</h4>
              </header>

              <p align="justify">
                <i>
                  "Grunt is a tool for task automation in Node."
                </i>
                <p align="right">- <a href="https://www.facebook.com/pedroboi?fref=ts">Dias, Pedro</a></p>
              </p>

              <p align="justify">
                Pedro is right! Grunt is a excellent tool to have in your projects! All of them! No exceptions! Use it!
                If you don't know, this is the time to learn it! It is very powerful. When I started stu<b>dying</b> Node
                I got confused! There is lot to learn! I was afraid to look into one more tool of this huge stack because
                it seemed hard and awkward. I couldn't see the benefits of it, I could do everything myself. But once I
                learned it I saw the light.
              </p>

              <p align="justify">
                Why use it? So you can automate all the little boring tasks that you have to do on your code every day.
                Just to name a few:
              </p>

              <ul>
                <li>Compile a distribution version;</li>
                <li>Concatenate, uglify, minify CSS/JS files;</li>
                <li>Bounce server after changes;</li>
                <li>Run tests;</li>
                <li>Run coverage tool;</li>
                <li>Move files around;</li>
                <li>Install libraries;</li>
                <li>Make Coffee.</li>
              </ul>

              <p align="justify">
                And those ones are just the ones that came up in my mind right now, we have a bunch of community plugins
                for us to use, and they keep growing. Non-stop. Seriously, it is non stop, it is kind of crazy.
              </p>

              <header>
                <h4>Gruntfile</h4>
              </header>

              <p align="justify">
                Now that I've built into your soul that Grunt is cool lets start understanding how it works: First, we
                need to install it:
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #a6e22e">$</span> <span style="color: #a6e22e">npm</span> <span style="color: #a6e22e">install</span> <span style="color: #a6e22e">grunt</span>
</pre></div>
              <div class="ac-caption">Installing Grunt</div>

              <p align="justify">
                We have to install the CLI from Grunt too, that allows us to user the command <b>grunt</b> in our terminals.
                This package must be installed globaly.
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #a6e22e">$</span> <span style="color: #a6e22e">npm</span> <span style="color: #a6e22e">install</span> <span style="color: #a6e22e">grunt</span><span style="color: #f92672">-</span><span style="color: #a6e22e">cli</span> <span style="color: #f92672">-</span><span style="color: #a6e22e">g</span>
</pre></div>
              <div class="ac-caption">Installing Grunt-CLI</div>

              <p align="justify">
                This time we are all set to go. We have Grunt installed. Now we have to tell Grunt what he can do. To do
                that we need to create a file named <i>Gruntfile.js</i> in our root folder (This file must be named this
                way, Grunt will look for this file once executed).
              </p>

              <div style="background: #202020; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
              <pre style="margin: 0; line-height: 125%">
                <span style="color: #d0d0d0">└── nodeCode</span>
                <span style="color: #d0d0d0">    ├── src</span>
                <span style="color: #d0d0d0">    ├── package.json</span>
                <span style="color: #d0d0d0">    └── Gruntfile.js</span>
              </pre>
              </div>
              <div class="ac-caption">Gruntfile.js In The Root Folder</div>

              <p align="justify">
                Ok, we have to know what to add to this new file of ours. First lets take a look into what this file
                should have inside.
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #a6e22e">module</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">exports</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
<span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">initConfig</span><span style="color: #f8f8f2">({</span>
  <span style="color: #a6e22e">task1</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">sub_task</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
     <span style="color: #f8f8f2">...</span>
    <span style="color: #f8f8f2">},</span>
    <span style="color: #a6e22e">sub_task2</span><span style="color: #f92672">:</span><span style="color: #f8f8f2">{</span>
      <span style="color: #f8f8f2">...</span>
    <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">});</span>

<span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">loadNpmTasks</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;package_task1&#39;</span><span style="color: #f8f8f2">);</span>

<span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">registerTask</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;default&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;task1&#39;</span><span style="color: #f8f8f2">]);</span>
<span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">registerTask</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;justOne&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;task1:sub_task2&#39;</span><span style="color: #f8f8f2">]);</span>
<span style="color: #f8f8f2">};</span>
</pre></div>
              <div class="ac-caption">Glance At a Gruntfile</div>

              <p align="justify">
                Here we can see how Grunt works. We have the <b>grunt-cli</b> installed with <b>grunt</b> in our environment.
                If we execute <i>grunt</i> in the terminal it will search for the <i>Gruntfile.js</i> and execute it.
                If you guessed that the task named <i>"default"</i> will be executed, you were right. The <i>"default"</i>
                task will execute <i>"task1"</i> that we configured on <b>grunt.initConfig()</b>.
              </p>

              <p align="justify">
                You may be asking about that <b>grunt.loadNpmTasks('package_task1');</b> line. This <b>loadNpmTasks</b>
                is loading the package/plugin needed to execute the <i>task1</i> task. Without it we can't run <i>task1</i>.
                Basically you need to load every plugin into <b>Grunt</b> if you want to use it.
              </p>

              <p align="justify">
                It is pretty obvious that when we call <b>grunt.registerTask()</b> we are registering available tasks to
                be executed. You can see that we can define which task to be executed in which command. We can even decide
                which sub-task to execute.
              </p>

              <header>
                <h4>Running a Task</h4>
              </header>

              <p align="justify">
                Enough talk. First thing, lets get right of this cursed task that is to bounce our server every time we
                do some changes. Lets automate it. First, we will install <a href="http://nodemon.io/">nodemon</a>. However,
                we need nodemon for <b>Grunt</b> that is <a href="https://github.com/ChrisWren/grunt-nodemon">grunt-nodemon</a>.
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #a6e22e">$</span> <span style="color: #a6e22e">npm</span> <span style="color: #a6e22e">install</span> <span style="color: #a6e22e">grunt-nodemon</span>
</pre></div>
              <div class="ac-caption">Installing Nodemon For Grunt</div>

              <p align="justify">
                Now that it is installed we will configure <b>nodemon</b> to watch and bounce our server once it is
                changed:
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #a6e22e">module</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">exports</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
<span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">initConfig</span><span style="color: #f8f8f2">({</span>
  <span style="color: #a6e22e">nodemon</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">express</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #a6e22e">script</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&#39;index.js&#39;</span><span style="color: #f8f8f2">,</span>
      <span style="color: #a6e22e">options</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">watch</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;src&#39;</span><span style="color: #f8f8f2">],</span>
        <span style="color: #a6e22e">cwd</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&#39;src&#39;</span>
      <span style="color: #f8f8f2">}</span>
    <span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">});</span>

<span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">loadNpmTasks</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;grunt-nodemon&#39;</span><span style="color: #f8f8f2">);</span>

<span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">registerTask</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;default&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;nodemon&#39;</span><span style="color: #f8f8f2">]);</span>
<span style="color: #f8f8f2">};</span>
</pre></div>
              <div class="ac-caption">Gruntfile with Nodemon</div>

              <p align="justify">
                And finally we call <b>grunt</b>.
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #a6e22e">$</span> <span style="color: #a6e22e">grunt</span>
</pre></div>
              <div class="ac-caption">Executing Grunt With Nodemon</div>


              <p align="justify">
                Now we can change our server the way we like it! We have a bunch of cool packages to add and play with!
                Don't be shy and search for the really useful ones!
              </p>
            </div>
          </section>

          <!-- Two -->
          <section id="two">
            <div class="container">
              <header class="major">
                <h2>Unit Test</h2>
              </header>

              <header>
                <h4>Concept</h4>
              </header>

              <p align="justify">
                Unit testing. Yes, Unit testing. As usual lets take a look on what it means.
              </p>

              <p align="justify">
                <i>"In computer programming, unit testing is a software testing method by which individual units of source
                  code, sets of one or more computer program modules together with associated control data, usage procedures,
                  and operating procedures, are tested to determine whether they are fit for use."</i>
                <p align="right">- Wikipedia</p>
              </p>

              <p align="justify">
                Or other words, it is a code that tests your whole code by snippets that were defined as a testable units.
                You can test method by method, class by class, flow by flow, integration, you name it.
                And <b>Node</b> has some neat tools for testing. We can even test client-side application with it.
              </p>

              <p align="justify">
                Since we have to start from somewhere I will show you <b>Mocha</b> with
                <b>Grunt</b>. Yes, automated tests, baby!
              </p>

              <header>
                <h4>Tech Stack</h4>
              </header>

              <p align="justify">
                As we are building an API the stack that we will use is:
              </p>

              <ul>
                <li><a href="http://mochajs.org/">Mocha</a> for our test framework;</li>
                <li><a href="https://www.npmjs.com/package/should">Should</a> as our BDD assertion library;</li>
                <li><a href="https://github.com/pghalliday/grunt-mocha-test">grunt-mocha-test</a> for our automated test task;</li>
                <li><a href="https://www.npmjs.com/package/supertest">Supertest</a> as our library to make requests in the test environment;</li>
                <li><a href="https://www.npmjs.com/package/blanket">Blanket</a> for test coverage.</li>
              </ul>

              <header>
                <h4>Configuring Grunt</h4>
              </header>

              <p align="justify">
                Everything should be installed with <b>NPM</b>, nice and easy. You can save those libraries with <i>--save-dev</i>.
                Installed everything? Go to go? NICE! Lets configure our gruntfile.
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #a6e22e">module</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">exports</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">initConfig</span><span style="color: #f8f8f2">({</span>
    <span style="color: #a6e22e">nodemon</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #a6e22e">express</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">script</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&#39;index.js&#39;</span><span style="color: #f8f8f2">,</span>
        <span style="color: #a6e22e">options</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
          <span style="color: #a6e22e">watch</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;src/&#39;</span><span style="color: #f8f8f2">],</span>
          <span style="color: #a6e22e">cwd</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&#39;src&#39;</span>
        <span style="color: #f8f8f2">}</span>
      <span style="color: #f8f8f2">}</span>
    <span style="color: #f8f8f2">},</span>
    <span style="color: #a6e22e">mochaTest</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #a6e22e">test</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">options</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
          <span style="color: #a6e22e">reporter</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&#39;spec&#39;</span><span style="color: #f8f8f2">,</span>
          <span style="color: #a6e22e">require</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&#39;blanketWrapper&#39;</span>
        <span style="color: #f8f8f2">},</span>
        <span style="color: #a6e22e">src</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;tests/*.js&#39;</span><span style="color: #f8f8f2">]</span>
      <span style="color: #f8f8f2">},</span>
      <span style="color: #a6e22e">coverage</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">options</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
          <span style="color: #a6e22e">reporter</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&#39;html-cov&#39;</span><span style="color: #f8f8f2">,</span>
          <span style="color: #a6e22e">quiet</span><span style="color: #f92672">:</span> <span style="color: #66d9ef">true</span><span style="color: #f8f8f2">,</span>
          <span style="color: #a6e22e">captureFile</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&#39;coverage.html&#39;</span>
        <span style="color: #f8f8f2">},</span>
        <span style="color: #a6e22e">src</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;tests/*.js&#39;</span><span style="color: #f8f8f2">]</span>
      <span style="color: #f8f8f2">}</span>
    <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">});</span>

  <span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">loadNpmTasks</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;grunt-nodemon&#39;</span><span style="color: #f8f8f2">);</span>
  <span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">loadNpmTasks</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;grunt-mocha-test&#39;</span><span style="color: #f8f8f2">);</span>

  <span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">registerTask</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;default&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;nodemon:express&#39;</span><span style="color: #f8f8f2">]);</span>
  <span style="color: #a6e22e">grunt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">registerTask</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;testServer&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&#39;mochaTest&#39;</span><span style="color: #f8f8f2">]);</span>
<span style="color: #f8f8f2">};</span>
</pre></div>

              <div class="ac-caption">Gruntfile With Nodemon and Mocha Configured</div>

              <p align="justify">
                Lets begin to explain: We've included the <i>mochaTest</i> task with two sub-tasks: <i>test</i>
                and <i>coverage</i>. First in the <i>test</i> sub-task, we defined two options inside <i>options</i>:
                <i>reporter</i> as "spec" (this is the default value that <b>grunt-mocha</b> ads for us without any explanation)
                and <i>require</i> as "blanketWrapper". This last one is for <b>Blanket</b> do its job and see how much of
                the code we've covered by the tests. <i>blanketWrapper</i> is the name of a file that we need to create
                to wrap <b>Blanket</b> inside <b>Mocha</b>'s <b>Grunt</b> task.
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #66d9ef">var</span> <span style="color: #a6e22e">path</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;path&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">srcDir</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">path</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">join</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">__dirname</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;src&#39;</span><span style="color: #f8f8f2">);</span>

<span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;blanket&#39;</span><span style="color: #f8f8f2">)({</span>
  <span style="color: #75715e">// Only files that match the pattern will be instrumented</span>
  <span style="color: #a6e22e">pattern</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">srcDir</span>
<span style="color: #f8f8f2">});</span>
</pre></div>
              <div class="ac-caption">blanketWrapper.js</div>

              <p align="justify">
                Last but not least, the <i>src</i> option. This one will define where <b>Mocha</b> can find the test code
                to be executed.
              </p>

              <p align="justify">
                The <i>coverage</i> sub-task is defining how we will report the test status. Inside <i>options</i> we defined
                that we will report in a coverage html template by <b>reporter: 'html-cov'</b>, quietly (meaning that
                <b>Blanket</b> should not print <b>Mocha</b>'s output into this file and the name of this coverage file
                should be <i>coverage.html</i>. We told <b>Blanket</b> where to find the test files too.
              </p>

              <header>
                <h4>Writing Tests</h4>
              </header>

              <p align="justify">
                Now for the test file. We will use our Dog Service from <a href="/acbook-nodejs/lecture3.html#one">Lecture 3: Middleware</a>.
                We have three endpoints:
              </p>

              <ul>
                <li>http://localhost:8080/dog</li>
                <li>http://localhost:8080/goodDog</li>
                <li>http://localhost:8080/wiggle</li>
              </ul>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #66d9ef">var</span> <span style="color: #a6e22e">serverObject</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;../src/server&#39;</span><span style="color: #f8f8f2">),</span>
  <span style="color: #a6e22e">request</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;supertest&#39;</span><span style="color: #f8f8f2">),</span>
  <span style="color: #a6e22e">should</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;should&#39;</span><span style="color: #f8f8f2">),</span>
  <span style="color: #a6e22e">dogData</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">name</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&#39;testDog&#39;</span>
  <span style="color: #f8f8f2">},</span>
  <span style="color: #a6e22e">updateDog</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">name</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">dogData</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">name</span><span style="color: #f8f8f2">,</span>
    <span style="color: #a6e22e">newName</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&#39;testDog2&#39;</span>
  <span style="color: #f8f8f2">};</span>

<span style="color: #a6e22e">describe</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Dog Service&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">server</span><span style="color: #f8f8f2">;</span>
  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">url</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;http://localhost:8080&#39;</span><span style="color: #f8f8f2">;</span>
  <span style="color: #a6e22e">request</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">url</span><span style="color: #f8f8f2">);</span>

  <span style="color: #a6e22e">before</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">done</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">server</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">serverObject</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">makeServer</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">done</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">});</span>

  <span style="color: #a6e22e">after</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">done</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">server</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">close</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">done</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">});</span>

  <span style="color: #a6e22e">it</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;should create a dog&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">done</span><span style="color: #f8f8f2">){</span>
    <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">get</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;/dog&#39;</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">send</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">dogData</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">expect</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">});</span>

  <span style="color: #a6e22e">it</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;should update the test dog&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">done</span><span style="color: #f8f8f2">){</span>
    <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">put</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;/dog&#39;</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">send</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">updateDog</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">expect</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">});</span>

  <span style="color: #a6e22e">it</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;should delete the first dog&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">done</span><span style="color: #f8f8f2">){</span>
    <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #66d9ef">delete</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;/dog/0&#39;</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">expect</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">end</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">){</span>
        <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">)</span> <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">done</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">);</span>

        <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">dog</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">;</span>
        <span style="color: #a6e22e">dog</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">should</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">not</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">be</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">empty</span><span style="color: #f8f8f2">;</span>
      <span style="color: #f8f8f2">});</span>
  <span style="color: #f8f8f2">});</span>

  <span style="color: #a6e22e">it</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;should wiggle the first dog\&#39;s tail&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">done</span><span style="color: #f8f8f2">){</span>
    <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">get</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;/wiggle/0&#39;</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">expect</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">end</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">){</span>
        <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">)</span> <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">done</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">);</span>

        <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">dogWiggle</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">;</span>
        <span style="color: #a6e22e">dogWiggle</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">should</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">not</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">be</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">empty</span><span style="color: #f8f8f2">;</span>
        <span style="color: #a6e22e">dogWiggle</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">should</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">be</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">an</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">instanceOf</span><span style="color: #f8f8f2">(String);</span>
      <span style="color: #f8f8f2">});</span>
  <span style="color: #f8f8f2">});</span>

  <span style="color: #a6e22e">it</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;should say that the first dog is a good dog&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">done</span><span style="color: #f8f8f2">){</span>
    <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">get</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;/goodDog/0&#39;</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">expect</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">end</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">){</span>
        <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">)</span> <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">done</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">);</span>

        <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">goodDog</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">;</span>
        <span style="color: #a6e22e">goodDog</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">should</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">not</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">be</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">empty</span><span style="color: #f8f8f2">;</span>
        <span style="color: #a6e22e">goodDog</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">should</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">be</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">an</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">instanceOf</span><span style="color: #f8f8f2">(String);</span>
      <span style="color: #f8f8f2">});</span>
  <span style="color: #f8f8f2">});</span>
<span style="color: #f8f8f2">});</span>
</pre></div>
              <div class="ac-caption">Test File For Dog Service</div>

              <p align="justify">
                WOW! That is huge! (That's what she said). But, wait a minute... its is readable! Yes sir! Using the power
                of this test stack we can use BDD do write our tests and anyone can understand what is going on! That is
                awesome!
              </p>

              <p align="justify">
                Ok, one step at a time. First lines are the imports that we need to run the tests, easy. Then we have some
                mock data to test everything. And next we have <b>describe()</b>. Ok, do not despair. We are only defining
                a scope. Inside this we can set up some configurations before and after our tests. For instance, we define
                the server URL that we are testing, bootstrap the <b>Supertest</b> library using <b>request(url);</b> and
                then we call <b>before()</b> and <b>after</b> methods.
              </p>

              <p align="justify">
                Those methods are defining what will happen before and after all the actual tests (We can define actions
                to be done before and after EACH test using <b>beforeEach()</b> and <b>afterEach()</b> respectively). And
                finally we define the tests.
              </p>

              <p align="justify">
                Each <b>it()</b> is a test defined. As we are testing APi calls we do not know when those will end. Therefore
                we tell mocha to give us a callback named <b>done</b> so we can call it when we finish testing the results
                that came with the request's response. And the rest is pretty readable! See for yourself, you literally
                read what the test is doing.
              </p>

              <p align="justify">
                Everything ready to be executed! Go running to your terminal en execute and type:
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #a6e22e">$</span> <span style="color: #a6e22e">grunt</span> <span style="color: #a6e22e">testServer</span>
</pre></div>
              <div class="ac-caption">Executing Our Test Task</div>

              <p align="justify">
                Blanket has created a file with its report, take a look and see what it created for us.
              </p>

              <p align="justify">
                Please, there is no need to hold your tears of happiness, let it flow.
              </p>
            </div>
          </section>

          <!-- Three -->
          <section id="three">
            <div class="container">
              <header class="major">
                <h2>Cookie Authentication</h2>
              </header>

              <p align="justify">
                Hello guys, how you doing? I'm feeling great! So great that I want to do some free style coding right now.
                As I said in the first lecture, <b>Node</b> is low level. You might be wandering about how secure <b>Node</b>
                is, how secure my application is right now. I can tell you, it is not secure.
              </p>

              <p align="justify">
                You could make calls from any client, from any browser with any kind of info. <b>Node</b> and <b>Express</b>
                do not provide to us any security layer. So it is our job to add one (it is fun!). One popular way that
                APIs are implementing is token based authentication.
              </p>

              <header>
                <h4>Token Based Authentication</h4>
              </header>

              <p align="justify">
                Why it is so popular? Well, with this concept you can have you RESTful service stay stateless however with
                the ability to know if the requester is trustable or not, using a public network. The core conpect is simple:
                Our API will provide to the requester a token. This token is responsible to define if the requester is trustable
                or not. We do this by checking the correctness of this token. As the API is providing this little guy we
                can encrypt information using our favorite algorithm with our hard-to-decode secret that will be private.
                This way no one can fake a token (more or less, there are ways but we are trying to make it as hard as
                possible, not impossible).
              </p>

              <p align="justify">
                Interesting, isn't it? The way that I want to teach you guys about it is using <b>Json Web Token</b>.
                Please read <a href="http://code.tutsplus.com/tutorials/token-based-authentication-with-angularjs-nodejs--cms-22543">this article</a>
                before continuing, because I will assume that you know what a JWT is.
              </p>

              <p align="justify">
                After getting our fact right here is what I want to tell you: I will create a token using <b>JWT</b> concept.
                This token will be stored in a cookie where I find a safe place to be stored. This can give me the feature
                of session in my application and security if I'm in a <b>HTTPS</b> environment.
              </p>

              <p align="justify">
                After defining this my application can now search for this cookie to do our authentication feature. I will
                add a middleware into my Dog Service that will be executed before any route that I find reasonable to have it.
                This middleware will get the token from the request's cookie, verify it and then decide if the request should
                be authorized or not. For that I will add two packages from <b>NPM</b>.
              </p>

              <ul>
                <li><a href="https://github.com/expressjs/cookie-parser">Cookie-Parser</a></li>
                <li><a href="https://github.com/auth0/node-jsonwebtoken">JsonWebToken</a></li>
              </ul>

              <header>
                <h4>The Middleware</h4>
              </header>

              <p align="justify">
                I've already told you what I'm about to code and I don't want to be redundant, so lets get directly to
                what matters
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #66d9ef">var</span> <span style="color: #a6e22e">jwt</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;jsonwebtoken&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">cookieName</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;dogServiceCookie&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">secret</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;HanSoloShootsFirst&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">issuer</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;Peter Griffin&#39;</span><span style="color: #f8f8f2">;</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">twoMinutes</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;2&#39;</span><span style="color: #f8f8f2">;</span>

<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">Auth</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">verifyAuth</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">request</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">cookie</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">cookies</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">config</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">cookieName</span><span style="color: #f8f8f2">];</span>
    <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">cookie</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #66d9ef">try</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">token</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">jwt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">verify</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">cookie</span><span style="color: #f8f8f2">,</span>
                                   <span style="color: #a6e22e">secret</span><span style="color: #f8f8f2">,</span>
                                   <span style="color: #f8f8f2">{</span><span style="color: #a6e22e">issuer</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">issuer</span><span style="color: #f8f8f2">,</span>
                                    <span style="color: #a6e22e">ignoreExpiration</span><span style="color: #f92672">:</span> <span style="color: #66d9ef">false</span><span style="color: #f8f8f2">});</span>
        <span style="color: #66d9ef">return</span> <span style="color: #66d9ef">true</span><span style="color: #f8f8f2">;</span>
      <span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">catch</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">error</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Request unauthorized. Error decoding token.&#39;</span><span style="color: #f8f8f2">);</span>
        <span style="color: #66d9ef">return</span> <span style="color: #66d9ef">false</span><span style="color: #f8f8f2">;</span>
      <span style="color: #f8f8f2">}</span>
    <span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Request unauthorized. No token available.&#39;</span><span style="color: #f8f8f2">);</span>
      <span style="color: #66d9ef">return</span> <span style="color: #66d9ef">false</span><span style="color: #f8f8f2">;</span>
    <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">};</span>

  <span style="color: #66d9ef">this</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">isAuthenticated</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">request</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">){</span>

    <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">verifyAuth</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">request</span><span style="color: #f8f8f2">))</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #a6e22e">next</span><span style="color: #f8f8f2">();</span>
    <span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">sendStatus</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">407</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">};</span>

  <span style="color: #66d9ef">this</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">signToken</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">payload</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">jwt</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">sign</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">payload</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">secret</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">{</span><span style="color: #a6e22e">issuer</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">issuer</span><span style="color: #f8f8f2">,</span>
                                      <span style="color: #a6e22e">expiresInMinutes</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">twoMinutes</span><span style="color: #f8f8f2">});</span>
  <span style="color: #f8f8f2">};</span>
<span style="color: #f8f8f2">};</span>

<span style="color: #a6e22e">module</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">exports</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #a6e22e">Auth</span><span style="color: #f8f8f2">();</span>
</pre></div>
              <div class="ac-caption">Cookie Authentication Middleware</div>

              <p align="justify">
                Now I'm going to add these middleware in the Dog Service code. I will add it in the <i>dog</i> route
                since it has the <b>DELTE</b>, <b>POST</b> and <b>PUT</b> methods.
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #66d9ef">var</span> <span style="color: #a6e22e">bodyParser</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;body-parser&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">parseUrlencoded</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">bodyParser</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">urlencoded</span><span style="color: #f8f8f2">({</span><span style="color: #a6e22e">extend</span><span style="color: #f92672">:</span> <span style="color: #66d9ef">false</span><span style="color: #f8f8f2">});</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">express</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;express&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">router</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">express</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">Router</span><span style="color: #f8f8f2">();</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">dogs</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;./dogs&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">auth</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;./auth&#39;</span><span style="color: #f8f8f2">);</span>

<span style="color: #a6e22e">router</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">use</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">auth</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">isAuthenticated</span><span style="color: #f8f8f2">);</span>
<span style="color: #a6e22e">router</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">use</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">parseUrlencoded</span><span style="color: #f8f8f2">);</span>

<span style="color: #a6e22e">router</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">route</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;/&#39;</span><span style="color: #f8f8f2">)</span>
  <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">post</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">request</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">){</span>
    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">data</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">;</span>
    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">newDog</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #a6e22e">Dog</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">data</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">name</span><span style="color: #f8f8f2">);</span>

    <span style="color: #a6e22e">dogs</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">push</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">newDog</span><span style="color: #f8f8f2">);</span>

    <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">status</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">201</span><span style="color: #f8f8f2">).</span><span style="color: #a6e22e">send</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Dog added! Brian loved it.&#39;</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">})</span>
  <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">put</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">request</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">){</span>
    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">dog</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">;</span>
    <span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">var</span> <span style="color: #a6e22e">x</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">dogs</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">length</span> <span style="color: #f92672">-</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">x</span> <span style="color: #f92672">&gt;=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span> <span style="color: #a6e22e">x</span><span style="color: #f92672">--</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">dogs</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">x</span><span style="color: #f8f8f2">].</span><span style="color: #a6e22e">getName</span><span style="color: #f8f8f2">()</span> <span style="color: #f92672">===</span> <span style="color: #a6e22e">dog</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">name</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #a6e22e">dogs</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">x</span><span style="color: #f8f8f2">].</span><span style="color: #a6e22e">setName</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">dog</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">newName</span><span style="color: #f8f8f2">);</span>
      <span style="color: #f8f8f2">}</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">sendStatus</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">});</span>

<span style="color: #a6e22e">router</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">route</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;/:doggyId&#39;</span><span style="color: #f8f8f2">)</span>
  <span style="color: #f8f8f2">.</span><span style="color: #66d9ef">delete</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">request</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">){</span>
    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">doggyId</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">params</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">doggyId</span><span style="color: #f8f8f2">;</span>

    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">dog</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">dogs</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">splice</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">doggyId</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">];</span>

    <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">json</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">dog</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">});</span>

<span style="color: #a6e22e">module</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">exports</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">router</span><span style="color: #f8f8f2">;</span>
</pre></div>
              <div class="ac-caption">Dog Service With Authentication</div>

              <p align="justify">
                Now I will create a login route.
              </p>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #66d9ef">var</span> <span style="color: #a6e22e">express</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;express&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">router</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">express</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">Router</span><span style="color: #f8f8f2">();</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">dogs</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;./dogs&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">auth</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;./auth&#39;</span><span style="color: #f8f8f2">);</span>

<span style="color: #a6e22e">router</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">route</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;/&#39;</span><span style="color: #f8f8f2">)</span>
  <span style="color: #f8f8f2">.</span><span style="color: #a6e22e">post</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">request</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">){</span>
    <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">data</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">request</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">body</span><span style="color: #f8f8f2">;</span>

    <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">data</span> <span style="color: #f92672">&amp;&amp;</span> <span style="color: #a6e22e">data</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">doggyId</span> <span style="color: #f92672">&amp;&amp;</span> <span style="color: #a6e22e">data</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">doggyId</span> <span style="color: #f92672">&lt;</span> <span style="color: #a6e22e">dogs</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">length</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">dog</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">dogs</span><span style="color: #f8f8f2">[</span><span style="color: #a6e22e">data</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">doggyId</span><span style="color: #f8f8f2">];</span>
      <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">payload</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">{</span><span style="color: #a6e22e">name</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">dog</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">name</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">id</span><span style="color: #f92672">:</span> <span style="color: #a6e22e">data</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">doggyId</span><span style="color: #f8f8f2">};</span>
      <span style="color: #66d9ef">var</span> <span style="color: #a6e22e">token</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">auth</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">signToken</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">payload</span><span style="color: #f8f8f2">);</span>
      <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">status</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">200</span><span style="color: #f8f8f2">).</span><span style="color: #a6e22e">json</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">token</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span><span style="color: #66d9ef">else</span><span style="color: #f8f8f2">{</span>
      <span style="color: #a6e22e">response</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">status</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">403</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">});</span>

<span style="color: #a6e22e">module</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">exports</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">router</span><span style="color: #f8f8f2">;</span>
</pre></div>
              <div class="ac-caption">loginRoute.js</div>

              <!-- HTML generated using hilite.me -->
              <div style="background: #272822; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #66d9ef">var</span> <span style="color: #a6e22e">express</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;express&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">app</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">express</span><span style="color: #f8f8f2">();</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">dogRoute</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;./dogRoute&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">goodDogRoute</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;./goodDogRoute&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">wiggleRoute</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;./wiggleRoute&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #66d9ef">var</span> <span style="color: #a6e22e">loginRoute</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">require</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;./loginRoute&#39;</span><span style="color: #f8f8f2">);</span>

<span style="color: #a6e22e">app</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">use</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;/dog&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">dogRoute</span><span style="color: #f8f8f2">);</span>
<span style="color: #a6e22e">app</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">use</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;/goodDog&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">goodDogRoute</span><span style="color: #f8f8f2">);</span>
<span style="color: #a6e22e">app</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">use</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;/wiggle&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">wiggleRoute</span><span style="color: #f8f8f2">);</span>
<span style="color: #a6e22e">app</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">use</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;/login&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">loginRoute</span><span style="color: #f8f8f2">);</span>

<span style="color: #a6e22e">app</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">listen</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">8080</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">function</span><span style="color: #f8f8f2">(){</span>
  <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;Listening on port 8080...&#39;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">});</span>
</pre></div>
              <div class="ac-caption">Adding Login Route To Our Application</div>

              <p align="justify">
                That is all it takes. Now we can test it to see if our operations over Dog Services are working.
              </p>
            </div>
          </section>
        </div>

      <!-- Footer -->
      <section id="footer">
        <div class="container">
          <ul class="copyright">
            <li>&copy; Avenue Code. All rights reserved.</li>
            <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
          </ul>
        </div>
      </section>
		</div>
	</body>
</html>